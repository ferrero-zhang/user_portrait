
 <style type="text/css">   
    .border-table {   
        border-collapse: collapse;   
        border: none;   
    }   
    .border-table td {   
        border: solid #FFE4B5 1px;   
    }   
    .group_block{
    background-color:#FF8C00;width:50px;height: 30px;padding: 5px 8px;color: white;font-weight: bold;border-radius: 0.25em;margin: 5px;display: inline-block;text-align: center;
    }
</style>
<div style="width:1000px;margin-bottom:0px;"><h3>情绪变动曲线</h3><hr style="width:1000px;"></div>
<div style="width:680px;height:470px;">
    <div style="float: right;">
       <input type="radio" name="time-type" value='day' onclick="choose_time()" style="width:15px;height:15px;margin-left:8px;" checked >本日
       <input type="radio" name="time-type" value='week' onclick="choose_time()" style="width:15px;height:15px;margin-left:8px;">本周
    </div>
    <div style="width:680px;height:400px;margin;0px;" id="emotion"></div>
</div>
<div id='select_time' style="font-weight:bold;margin:0px;margin-left:20px;font-size:12px;"></div>

<div style="width:280px;height:340px;background-color:whitesmoke;margin-left:20px;overflow-y:auto;" id="content">
    <div id="thought_weibo_text" style="padding:0px 10px;">
    </div>
</div>

    <div style="width:100%;"><span class="fleft" style="margin-right:10px;width:32px;height:32px;background-image:url(/static/img/warning.png);display:black;"></span><h4 style="line-height:32px;" ><span  id="con_emotion0"></span><span style="color:red;" id="con_emotion"></span></h4></div>


<div style="width:998px;">
	<div>
		<div style="height:380px;width:450px;float:left;margin-top:-20px">
		<div style="width:100%;font-size:24px;margin:0px;">性格特征<hr style="margin-top:10px;margin-right:20px;" /></div>
		<!-- <div id="sen_trend" style="height:350px;width:450px;"></div> -->
        <div>
            <div>根据情绪特征划分为：</div>
            <span class="group_block">积极</span> <span style="background-color:gray;" class="group_block">中性</span> <span style="background-color:gray;" class="group_block">消极</span>
        </div>
        <div>
            <div>根据语言特征划分为：</div>
            <span  class="group_block">积极</span> <span style="background-color:gray;" class="group_block">中性</span>
		    </div>
        </div>
		<div style="height:380px;width:450px;float:right;margin-top:-20px;margin-left:98px;">
		<div style="width:100%;font-size:24px;margin:0px;">心理状态<span type="button"data-toggle="modal" data-target="#psy_more"  style='font-size:16px;margin-left:270px;cursor: pointer'><u>查看更多</u></span><hr style="margin-top:10px;margin-right:20px;" /></div>
		<div id="pie_emotion" style="height:350px;width:450px;"></div>
		</div>
	</div>	
</div>

<div class="modal fade" id="psy_more" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="position: absolute;margin-top: 100px;margin-left: 500px;float :none;width: 400px;">
      <div class="modal-header" style="float:inherit;margin:initial;">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">心理状态</h4>
      </div>
      <div class="modal-body" style="float:none;" id="psy0">
      </div>
      <div class="modal-footer" style="width: 380px;">
        <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
      </div>
    </div>
  </div>
</div>



<script src="/static/js/echarts-all.js"></script>
<script type="text/javascript">
function call_ajax_request(url, callback){
    $.ajax({
        url: url,
        type: 'get',
        dataType: 'json',
        async: false,
        success: callback
    });
}
function Thought(){
  this.ajax_method = 'GET';
    }
Thought.prototype = {   //获取数据，重新画表
    call_sync_ajax_request:function(url, method, callback){
      $.ajax({
        url: url,
        type: method,
        dataType: 'json',
        async: false,
        success:callback
      });
    },
    Draw_emotion:function(data){
        var items = data;
        if(items==null){
            var say = document.getElementById('emotion');
            say.innerHTML = '该用户暂无此数据';
        }else{
            con0 = document.getElementById('con_emotion0');
            con0.innerHTML = items['description'][0];
            con = document.getElementById('con_emotion');
            con.innerHTML = items['description'][1];
            emotions(items);
            var time_init = new Date(items['time_list'][0]);
            var times_init = time_init.getTime().toString().substr(0,10);
            //console.log(times_init);    
            var html0 = '';
            url_content = '/attribute/sentiment_weibo/?uid='+uid+'&start_ts='+times_init+'&time_type='+index+'&sentiment=0';
            call_ajax_request(url_content,th_draw_content);
            $('#select_time').empty();  
            html0 += "<div>当前选择时间段：</div><div style='color:brown;'>"+items['time_list'][0]+"</div><br><div>当前选择情绪：</div><div style='color:brown;'>中性</div>";
            $('#select_time').append(html0);
        }   
    }
}

var Thought = new Thought();
index = $('input[name="time-type"]:checked').val();
url = '/attribute/sentiment_trend/?uid='+uid+'&time_type='+index;
Thought.call_sync_ajax_request(url, Thought.ajax_method, Thought.Draw_emotion);
//url_content = '/attribute/sentiment_weibo/?uid='+uid+'&start_ts=1378567800&time_type='+index+'&sentiment=1';
//call_ajax_request(url_content,th_draw_content);
url_think = '/attribute/tendency_psy/?uid='+uid;
call_ajax_request(url_think,draw_think);
//call_ajax_request(url_think,draw_trend);
//call_ajax_request(url_think,draw_more_psy);


function choose_time(){            
    index = $('input[name="time-type"]:checked').val();
    url = '/attribute/sentiment_trend/?uid='+uid+'&time_type='+index;
    Thought.call_sync_ajax_request(url, Thought.ajax_method, Thought.Draw_emotion);
    //$('#emotion').empty();
  }

function th_draw_content(data){
    var html = '';
    $('#thought_weibo_text').empty();
    $('#select_time').empty();
    if(data==''){
        html += "<div style='width:100%;'><span style='margin-left:20px;'>该时段用户未发布任何微博</span></div>";
    }else{
        for(i=0;i<data.length;i++){
            //console.log(data[i].text);
            html += "<div style='width:100%;'><img src='/static/img/pencil-icon.png' style='height:10px;width:10px;margin:0px;margin-right:10px;'><span>"+data[i]['text']+"</span></div>";
        }
    }
    $('#thought_weibo_text').append(html);
}

function emotions(data){
    var times = [];
    var time_name = [];
    if (index =='week'){
        times = data['time_list'];}
    else{
        for (var t in data['time_list']){
            //console.log(data['time_list'][t]);
            times.push(data['time_list'][t].substr(11,5));
        }
    }
    time_name = data['time_list'];
    //console.log(times);
    var names = ['中性','积极','悲伤','愤怒']; 
    var data0 = data['trend_result']['0'];
    var data1 = data['trend_result']['1'];
    var data2 = data['trend_result']['2'];
    var data3 = data['trend_result']['3'];
    var datas = [data0,data1,data2,data3];
    var nods = {};
    var nodcontent = [];
    for(i=0;i<4;i++){
        nods = {};
        nods['name'] = names[i];
        nods['type'] = 'line';
        nods['data'] = datas[i];
        nodcontent.push(nods);
    }
    //console.log(nodcontent[0]);

    var myChart1 = echarts.init(document.getElementById('emotion'));
    var option = {
    tooltip : {
        trigger: 'axis'
    },
    legend: {
        data:names
    },
    toolbox: {
        show : false,
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            magicType : {show: true, type: ['line', 'bar']},
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            boundaryGap : false,
            data : times
        }
    ],
    yAxis : [
        {
            type : 'value',
        }
    ],
    series : nodcontent
    };
    myChart1.setOption(option); 
    require([
            'echarts'
        ],
        function(ec){
            var ecConfig = require('echarts/config');
            function focus(param) {
                var sentiment = param.seriesIndex;
                var date = new Date(time_name[param.dataIndex]);
                var starts_ts = date.getTime().toString().substr(0,10);
                if(index == 'week'){
                var start_ts = parseInt(starts_ts)-28800;                   
                }
                else if(index == 'day'){var start_ts = starts_ts;}
                ajax_url = '/attribute/sentiment_weibo/?uid='+uid+'&start_ts='+start_ts+'&time_type='+index+'&sentiment='+sentiment;
                $.ajax({
                      url: ajax_url,
                      type: 'GET',
                      dataType: 'json',
                      async: false,
                      success:th_draw_content
                    });
                var html0 = '';
                $('#select_time').empty();  
                html0 += "<div>当前选择时间段：</div><div style='color:brown;'>"+time_name[param.dataIndex]+"</div><br><div>当前选择情绪：</div><div style='color:brown;'>"+names[sentiment]+'</div>';
                $('#select_time').append(html0);
                }
            myChart1.on(ecConfig.EVENT.CLICK, focus);
            }
            
    )
}
  
function draw_think(data){
    console.log(data['description']);
    // if(items==null){
    //     var say = document.getElementById('emotion');
    //     say.innerHTML = '该用户暂无此数据';
    // }else{
    //     con = document.getElementById('con_emotion');
    //     con.innerHTML = items['description'][1];  
    //     }  
    var first = data['psy_first'];
    var second = data['psy_second'];
    var first_name = ['积极','消极','中性'];
    var second_name = ['愤怒','其他','焦虑','悲伤'];
    var first_content = [];
    var second_content = [];
    var nod = {};
    var neg = 0;
    var i = 0;
    for(var key in first){
        var nod = {};
        nod['name'] = first_name[i];
        nod['value'] = first[key].toFixed(2);
        nod['init'] = key;
        first_content.push(nod);
        if(key == 'negemo'){
            neg = first[key];
            var j = 0;
            for(var keys in second){
                var nod = {};
                nod['name'] = second_name[j];
                nod['value'] = (second[keys] * neg).toFixed(2);
                nod['init'] = keys;
                second_content.push(nod);
                j = j + 1;
                //second_name.push(key);
            }
        }
        else {
            second_content.push(nod);
        }
        i = i + 1;
        //first_name.push(key);
    }
    var change = data['psy_change'];
    var self_0 = '';
    var compare_0 = '';
    $('#psy0').empty();
    html = '';
    html += '<table class="table table-striped table-bordered bootstrap-datatable datatable responsive">';
    html += '<tr><th style="text-align:center">情绪</th><th style="text-align:center">当前值</th></tr>';
    for (var i in second_content){
        for(var key in change){
            if (key == second_content[i]['init']){
                if(change[key][0]==0){
                    self_0='/static/img/stable.png';
                }else if(change[key][0]==1){
                    self_0='/static/img/up.png';
                }else if(change[key][0]==-1){
                    self_0='/static/img/down.png';
                }
                if(change[key][1]==0){
                    compare_0='（与平均水平持平）';
                }else if(change[key][1]==1){
                    compare_0='（高于平均水平）';
                }else if(change[key][1]==-1){
                    compare_0='（低于平均水平）';
                }
            }
        }
        html += '<tr><th style="text-align:center">' + second_content[i]['name'] + '</th><th style="text-align:center">' + second_content[i]['value'] +'<img style="height:10px;margin:0px;" src='+self_0+'>'+compare_0+ '</th></tr>';
        if (i ==0){
            var key = 'negemo';
                if(change[key][0]==0){
                    self_0='/static/img/stable.png';
                }else if(change[key][0]==1){
                    self_0='/static/img/up.png';
                }else if(change[key][0]==-1){
                    self_0='/static/img/down.png';
                }
                if(change[key][1]==0){
                    compare_0='（与平均水平持平）';
                }else if(change[key][1]==1){
                    compare_0='（高于平均水平）';
                }else if(change[key][1]==-1){
                    compare_0='（低于平均水平）';
                }
        
        html += '<tr><th style="text-align:center">' + first_content[1]['name'] + '</th><th style="text-align:center">' + first_content[1]['value'] +'<img style="height:10px;margin:0px;" src='+self_0+'>'+compare_0+ '</th></tr>';
         }
    }

    
    html += '</table>'; 
    $('#psy0').append(html);  



    var myChart = echarts.init(document.getElementById('pie_emotion'));
    var option = {
    tooltip : {
        trigger: 'item',
        formatter: "{a} <br/>{b} : {c} ({d}%)"
    },
    toolbox: {
        show : true,
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            magicType : {
                show: true, 
                type: ['pie', 'funnel']
            },
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    calculable : false,
    series : [
        {
            name:'访问来源',
            type:'pie',
            selectedMode: 'single',
            radius : [0, 70],
            
            // for funnel
            x: '20%',
            width: '40%',
            funnelAlign: 'right',
            max: 1548,
            
            itemStyle : {
                normal : {
                    label : {
                        position : 'inner'
                    },
                    labelLine : {
                        show : false
                    }
                }
            },
            data:first_content
        },
        {
            name:'访问来源',
            type:'pie',
            radius : [100, 140],
            
            // for funnel
            x: '60%',
            width: '35%',
            funnelAlign: 'left',
            max: 1048,
            
            data:second_content
        }
    ]
    };
    myChart.setOption(option); 
    var ecConfig = require('echarts/config');
    myChart.on(ecConfig.EVENT.PIE_SELECTED, function (param){
    var selected = param.selected;
    var serie;
    var str = '当前选择： ';
    for (var idx in selected) {
        serie = option.series[idx];
        for (var i = 0, l = serie.data.length; i < l; i++) {
            if (selected[idx][i]) {
                str += '【系列' + idx + '】' + serie.name + ' : ' + 
                       '【数据' + i + '】' + serie.data[i].name + ' ';
            }
        }
    }
    document.getElementById('wrong-message').innerHTML = str;
    })
                    
}

function draw_trend(data){
    
    var nods = [];
    var nod = {};
    var nodcontent = [];
    var nodcon0 = {};
    var nod = {};
    nod['name'] = 'tendency';
    nod['value'] = data['tendency'];
    nods.push(nod);
    
    for (i=0;i<nods.length;i++){
        var nodcon0 = {};
        nodcon0['name'] = i;
        nodcon0['type'] = 'gauge';
        nodcon0['min'] = 0;
        nodcon0['max'] = 3;
        //nodcon0['center'] = 
        nodcon0['data'] = [{'value':nods[i]['value'],'name':nods[i]['name']}]
        //nodcon0['data'] = nods[i];
        nodcontent.push(nodcon0);
    }

    var myChart = echarts.init(document.getElementById('sen_trend'));
    var option = {
    tooltip : {
        formatter: "{a} <br/>{b} : {c}%"
    },
    toolbox: {
        show : true,
        feature : {
            mark : {show: true},
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    series : nodcontent
    };
       myChart.setOption(option);              
}
    
</script>
