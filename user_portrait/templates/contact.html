{% extends "tbase.html" %}
{% block main %}
<link href="/static/css/lanrenzhijia.css" type="text/css" rel="stylesheet" />
<script src="/static/js/lanrenzhijia.js" type="text/javascript"></script>
<script type="text/javascript" src='/static/js/esl.js'></script>
<script type="text/javascript" src='/static/js/echarts-all.js'></script>
<script type="text/javascript" src='/static/js/echarts.js'></script>
<style>
    .caroufredsel_wrapper{
        left: -16px;
    }
</style>
<script>
    $(function() {
        $('#tabs').carouFredSel({
            circular: false,
            items: 1,
            width: '100%',
            auto: false,
            pagination: {
                container: '#pager',
                anchorBuilder: function( nr ) {
                    if($(this).attr('id')== 'txt'){
                        return '<a href="#">列表视图</a>';
                    }
                    else{
                        return '<a href="#">图标视图</a>';
                    }
                    // return '<a href="#">' + $(this).find('h3').text() + '</a>';
                }
            }
        });
    });
</script>
<div class='row'>
<div class="box col-md-12" >
    <div class="box-inner">
        <div class="box-header" data-original-title="">
            <h2 style='margin-left:5px'>条件选择</h2>
        </div>
        <div class="box-content" style="height:200px">
            <div class="col-md-12">
                <label class='control-label'>关联维度：</label>
                <div class='controls'>
                    <div class='col-md-12' style="margin-bottom:4px">
                        <div class='col-lg-3'>
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="domain">领域</span>                             
                             <input type='text' class="form-control" style='width:40%; display:inline-block;height:25px' disabled>
                        </div>

                         <div class='col-lg-3'>
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="topic">话题</span>
                             <input type='text' class="form-control" style='width:40%; display:inline-block;height:25px' disabled>
                        </div>
                         <div class='col-lg-3'>
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="keywords">关键词</span>
                             <input type='text' class="form-control" style='width:40%; display:inline-block;height:25px' disabled>
                        </div>
                        <div class='col-lg-3'>
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="psycho_status">心理状态</span>
                             <input type='text' class="form-control" style='width:40%; display:inline-block;height:25px' disabled>
                        </div>
                    </div>
                    <div class='col-md-12'>
                         <div class='col-lg-3' >
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="psycho_feature">心理特征</span>
                             <input type='text' class="form-control" style='width:40%; display:inline-block;height:25px' disabled>
                        </div>
                        <div class='col-lg-3'>
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="activity_geo">地理特征</span>
                             <input type='text' class="form-control" style='width:40%; display:inline;height:25px' disabled>
                        </div>
                        <div class='col-lg-3' >
                            <input type='checkbox' class='inline-checkbox' value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" id="hashtag">hashtag</span>
                             <input type='text' class="form-control" style='width:40%; display:inline;height:25px' disabled>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12" style="padding-top:5px">
                <label class='control-label'>排序方法：</label>
                <div class='controls'>
                    <div class='col-md-12'>
                        <div class='col-lg-3'>
                            <input type='radio' id="default" name="inlineRadioOptions" value='option1' checked='checked'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" >默认排序</span>
                        </div>
                        <div class='col-lg-3'>
                            <input type='radio' id="importance" name="inlineRadioOptions" value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" >重要度排序</span>
                        </div>
                        <div class='col-lg-3'>
                            <input type='radio' id="activeness" name="inlineRadioOptions" value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" >活跃度排序</span>
                        </div>
                        <div class='col-lg-3'>
                            <input type='radio' id="influence" name="inlineRadioOptions" value='option1'>
                            <span class="input-group-addon" style="width:96px;border:1px solid #eeeeee; display:inline-block" >影响力排序</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12" style='margin-top:19px'>
                <div class='col-md-12' style='text-align:right; padding-right:35px'>
                    <span class="label label-success" style='cursor:pointer;'>提交</span>
                </div>
            </div>
        </div>
    </div>
</div>
 
</div>
<div id="wrapper" style="padding-left:0px; overflow:visible">
        <div id='pager'></div>
        <div id='tabs' style='width:1000px'>
            <div id='txt'>
                <div class="main col-sm-9 col-md-10">
                    <div class="col-sm-12">
                        <div class="panel panel-default" style="width:1000px; height:429px;margin-left:-30px" id='table'>
                        </div>
                    </div>
                </div>
            </div>
            <div id='photo'>
                <div class="main col-sm-9 col-md-10">
                    <div class="col-sm-12">
                        <div class="panel panel-default" style="width:1000px; height:400px;margin-left:-30px" id='echart'>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</div>
<script type="text/javascript">
    
//draw function
function Search_weibo(){
  this.ajax_method = 'GET';
  this.data ;
}

Search_weibo.prototype = {
    call_sync_ajax_request:function(url, method, callback){
        $.ajax({
          url: url,
          type: method,
          dataType: 'json',
          async: false,
          success:callback
        });
    },

    Get_Callback_data:function(data){

        return data;
    },
        
    Draw_table: function(data){
        $('#table').empty();
        var html = '';
        var height = 39 * (data.length+1);
        html += '<table class="table table-striped table-bordered bootstrap-datatable datatype responsive">';
        html += '<thead><tr><th class="center" style="text-align:center">用户id</th><th class="center" style="text-align:center">昵称</th><th class="center" style="text-align:center">重要度</th><th class="center" style="text-align:center;width:72px">活跃度</th><th class="center" style="text-align:center">影响力</th><th class="center" style="text-align:center">得分</th></tr></thead>';
        html += '<tbody>';
        for(var item in data){
            html += '<tr>';
            for(var i =0; i < data[item].length; i++){  
                if(data[item][i] == 'unknown'){
                    data[item][i] = '未知'
                }
                if(i > 2) {
                    html += '<td class="center" style="text-align:center;vertical-align:middle">'+ data[item][i].toFixed(2) +'</td>';
                }
                else{
                   html += '<td class="center" style="text-align:center;vertical-align:middle">'+ data[item][i] +'</td>'; 
                }            
               
            }
            html += '</tr>';
        }
        html += '</tbody>';
        html += '</table>';
        $('#table').css('height',height);
        $('#table').append(html);
    },

    Draw_picture: function(data){
        var Related_Node = new Array();
        var Related_Link = new Array();
        var user_name = data[0][1];
        console.log(Related_Node);
        for(var item =0; item < data.length; item++){
            if(data[item][1]=='unknown'){
                Related_Node.push({'name':data[item][0], 'value':data[item][5], 'label':data[item][1]});
                Related_Link.push({'source':user_name, 'target':data[item][0], 'weight':data[item][5]});
            }
            else{
                Related_Node.push({'name':data[item][1], 'value':data[item][5], 'label':data[item][1]});
                Related_Link.push({'source':user_name, 'target':data[item][1], 'weight':data[item][5]});
            }
        }
        var option = {
                title : {
                    text: '',
                    subtext: '',
                    x:'right',
                    y:'bottom'
                },
                tooltip : {
                    trigger: 'item',
                    formatter: '{a} : {b}'
                },
                toolbox: {
                    show : true,
                    feature : {
                        restore : {show: true},
                        magicType: {show: true, type: ['force', 'chord']},
                        saveAsImage : {show: true}
                    }
                },
                series : [
                    {
                        type:'force',
                        name : "人物关系",
                        ribbonType: false,
                        itemStyle: {
                            normal: {
                                label: {
                                    show: true,
                                    textStyle: {
                                        color: '#333'
                                    }
                                },
                                nodeStyle : {
                                    brushType : 'both',
                                    borderColor : 'rgba(255,215,0,0.4)',
                                    borderWidth : 1
                                },
                                linkStyle: {
                                    type: 'curve'
                                }
                            },
                            emphasis: {
                                label: {
                                    show: false
                                    // textStyle: null      // 默认使用全局文本样式，详见TEXTSTYLE
                                },
                                nodeStyle : {
                                    //r: 30
                                },
                                linkStyle : {}
                            }
                        },
                        useWorker: false,
                        minRadius : 15,
                        maxRadius : 25,
                        gravity: 1.1,
                        scaling: 1.1,
                        roam: 'move',
                        nodes: Related_Node,
                        links : Related_Link,
                    }
                ]
        };  

        var myChart = echarts.init(document.getElementById('echart'));
        myChart.setOption(option);
        //回调函数，添加监听事件
        require([
                'echarts'
            ],
            function(ec){
                var ecConfig = require('echarts/config');
                function focus(param) {
                    var data = param.data;
                    var links = option.series[0].links;
                    var nodes = option.series[0].nodes;
                    if (
                        data.source != null
                        && data.target != null
                    ) { //点击的是边
                        var sourceNode = nodes.filter(function (n) {return n.name == data.source})[0];
                        var targetNode = nodes.filter(function (n) {return n.name == data.target})[0];
                        // console.log("选中了边 " + sourceNode.name + ' -> ' + targetNode.name + ' (' + data.weight + ')');
                    } else { // 点击的是点
                    }
                }
                    myChart.on(ecConfig.EVENT.CLICK, focus)

                    myChart.on(ecConfig.EVENT.FORCE_LAYOUT_END, function () {
                        console.log(myChart.chart.force.getPosition());
                    });
                }
        )     
    }
}

var Search_weibo = new Search_weibo();
$('.label-success').click(function(){
    Search_weibo.call_sync_ajax_request(get_choose_data(), Search_weibo.ajax_method, Search_weibo.Draw_table);
    Search_weibo.call_sync_ajax_request(get_choose_data(), Search_weibo.ajax_method, Search_weibo.Draw_picture);
});

$('.inline-checkbox').click(function(){
    if($(this).is(':checked')){
        $(this).next().next().val('1');
        $(this).next().next().attr('disabled',false);
    }
    else{
        $(this).next().next().val('');
        $(this).next().next().attr('disabled',true);
    }
});

//获取选择的条件，把参数传出获取返回值
function get_choose_data(){
    var url = '/manage/imagine/?uid=2001627641&keywords='
    var keywords = new Array();
    var weight = new Array();
    var field ;
    $('.inline-checkbox').each(function(){
        if($(this).is(':checked')){
            keywords.push($(this).next().attr('id'));
            weight.push($(this).next().next().val());
        }
    });
    $('[type="radio"]').each(function(){
        if($(this).is(':checked')){
            filed = $(this).attr('id');
        }
    });
    url = url + keywords.join(',') + '&weight=' + weight.join(',') + '&field=' +filed ;
    return url;
}

</script>

{% endblock %}
